<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConfigUser - Configuration des Animations</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            width: 100%;
            max-width: 600px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
            font-size: 1.1em;
        }

        select, input[type="time"], input[type="datetime-local"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }

        .loading.show {
            display: block;
        }

        .message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .preview h3 {
            color: #495057;
            margin-bottom: 10px;
        }

        .preview p {
            color: #6c757d;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé≠ Configuration des Animations</h1>
        
        <form id="configForm">
            <div class="form-group">
                <label for="animationStartTime">‚è∞ Heure de d√©but de l'animation</label>
                <input type="datetime-local" id="animationStartTime" name="animationStartTime" required>
            </div>

            <div class="form-group">
                <label for="eventType">üèüÔ∏è Type d'√©v√©nement</label>
                <select id="eventType" name="eventType" required>
                    <option value="">S√©lectionnez un type d'√©v√©nement</option>
                    <option value="football_stadium">üèà Stade de Football</option>
                    <option value="theater">üé≠ Th√©√¢tre</option>
                    <option value="concert_hall">üéµ Salle de Concert</option>
                    <option value="arena">üèüÔ∏è Ar√©na Sportive</option>
                    <option value="conference_center">üìä Centre de Conf√©rence</option>
                    <option value="cinema">üé¨ Cin√©ma</option>
                </select>
            </div>

            <div class="form-group">
                <label for="animationType">‚ú® Type d'animation</label>
                <select id="animationType" name="animationType" required>
                    <option value="">S√©lectionnez un type d'animation</option>
                    <option value="blue_black_flash">‚ö° Flash Bleu/Noir</option>
                    <option value="checkboard_flash">üèÅ Flash Damier (Rouge/Bleu)</option>
                </select>
            </div>

            <div class="preview" id="configPreview" style="display: none;">
                <h3>üìã Aper√ßu de la configuration</h3>
                <p><strong>Heure de d√©but:</strong> <span id="previewTime"></span></p>
                <p><strong>√âv√©nement:</strong> <span id="previewEvent"></span></p>
                <p><strong>Animation:</strong> <span id="previewAnimation"></span></p>
            </div>

            <button type="submit" class="btn" id="submitBtn">
                üíæ Sauvegarder la Configuration
            </button>
        </form>

        <div class="loading" id="loading">
            <p>‚è≥ Sauvegarde en cours...</p>
        </div>

        <div id="message"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getFirestore, collection, addDoc, serverTimestamp, doc, setDoc, query, where, getDocs, updateDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { getStorage, ref, uploadString, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAWGEHQK8f61d4OCgreDRu0fXUjt_sG14w",
            authDomain: "data-base-test-6ef5f.firebaseapp.com",
            projectId: "data-base-test-6ef5f",
            storageBucket: "data-base-test-6ef5f.firebasestorage.app",
            messagingSenderId: "131672469882",
            appId: "1:131672469882:web:5362c975813f74955be6c3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Animation data - Available animations
        const animationData = {
            blue_black_flash: {
                animationId: "blue_black_flash",
                frameRate: 2,
                frameCount: 20,
                type: "color_animation",
                users: {
                    "user_1_1": {
                        colors: [
                            {r: 0, g: 0, b: 255}, {r: 0, g: 0, b: 0}, {r: 0, g: 0, b: 255}, {r: 0, g: 0, b: 0},
                            {r: 0, g: 0, b: 255}, {r: 0, g: 0, b: 0}, {r: 0, g: 0, b: 255}, {r: 0, g: 0, b: 0},
                            {r: 0, g: 0, b: 255}, {r: 0, g: 0, b: 0}, {r: 0, g: 0, b: 255}, {r: 0, g: 0, b: 0},
                            {r: 0, g: 0, b: 255}, {r: 0, g: 0, b: 0}, {r: 0, g: 0, b: 255}, {r: 0, g: 0, b: 0},
                            {r: 0, g: 0, b: 255}, {r: 0, g: 0, b: 0}, {r: 0, g: 0, b: 255}, {r: 0, g: 0, b: 0}
                        ]
                    }
                }
            },
            checkboard_flash: {
                animationId: "checkboard_flash",
                frameRate: 2,
                frameCount: 20,
                type: "color_animation",
                users: {
                    "user_1_1": {
                        colors: [
                            {r: 255, g: 0, b: 0}, {r: 0, g: 0, b: 0}, {r: 255, g: 0, b: 0}, {r: 0, g: 0, b: 0},
                            {r: 255, g: 0, b: 0}, {r: 0, g: 0, b: 0}, {r: 255, g: 0, b: 0}, {r: 0, g: 0, b: 0},
                            {r: 255, g: 0, b: 0}, {r: 0, g: 0, b: 0}, {r: 255, g: 0, b: 0}, {r: 0, g: 0, b: 0},
                            {r: 255, g: 0, b: 0}, {r: 0, g: 0, b: 0}, {r: 255, g: 0, b: 0}, {r: 0, g: 0, b: 0},
                            {r: 255, g: 0, b: 0}, {r: 0, g: 0, b: 0}, {r: 255, g: 0, b: 0}, {r: 0, g: 0, b: 0}
                        ]
                    },
                    "user_1_2": {
                        colors: [
                            {r: 0, g: 0, b: 255}, {r: 0, g: 0, b: 0}, {r: 0, g: 0, b: 255}, {r: 0, g: 0, b: 0},
                            {r: 0, g: 0, b: 255}, {r: 0, g: 0, b: 0}, {r: 0, g: 0, b: 255}, {r: 0, g: 0, b: 0},
                            {r: 0, g: 0, b: 255}, {r: 0, g: 0, b: 0}, {r: 0, g: 0, b: 255}, {r: 0, g: 0, b: 0},
                            {r: 0, g: 0, b: 255}, {r: 0, g: 0, b: 0}, {r: 0, g: 0, b: 255}, {r: 0, g: 0, b: 0},
                            {r: 0, g: 0, b: 255}, {r: 0, g: 0, b: 0}, {r: 0, g: 0, b: 255}, {r: 0, g: 0, b: 0}
                        ]
                    }
                }
            }
        };

        const form = document.getElementById('configForm');
        const submitBtn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');
        const messageDiv = document.getElementById('message');
        const preview = document.getElementById('configPreview');

        const eventTypeSelect = document.getElementById('eventType');
        const animationTypeSelect = document.getElementById('animationType');
        const timeInput = document.getElementById('animationStartTime');

        function updatePreview() {
            const eventType = eventTypeSelect.value;
            const animationType = animationTypeSelect.value;
            const time = timeInput.value;

            if (eventType && animationType && time) {
                const eventText = eventTypeSelect.options[eventTypeSelect.selectedIndex].text;
                const animationText = animationTypeSelect.options[animationTypeSelect.selectedIndex].text;
                const formattedTime = new Date(time).toLocaleString('fr-FR');

                document.getElementById('previewTime').textContent = formattedTime;
                document.getElementById('previewEvent').textContent = eventText;
                document.getElementById('previewAnimation').textContent = animationText;
                
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }

        eventTypeSelect.addEventListener('change', updatePreview);
        animationTypeSelect.addEventListener('change', updatePreview);
        timeInput.addEventListener('change', updatePreview);

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(form);
            const animationType = formData.get('animationType');
            const eventType = formData.get('eventType');
            const selectedAnimation = animationData[animationType];
            
            if (!selectedAnimation) {
                messageDiv.innerHTML = `
                    <div class="message error">
                        ‚ùå Type d'animation non valide
                    </div>
                `;
                return;
            }

            const config = {
                animationStartTime: formData.get('animationStartTime'),
                eventType: eventType,
                animationType: animationType,
                animationData: selectedAnimation,
                createdAt: serverTimestamp(),
                status: 'active'
            };

            try {
                submitBtn.disabled = true;
                loading.classList.add('show');
                messageDiv.innerHTML = '';

                // First, find and deactivate any existing active animations for this event type
                const existingQuery = query(
                    collection(db, 'animation_configs'),
                    where('eventType', '==', eventType),
                    where('status', '==', 'active')
                );
                
                const existingSnapshot = await getDocs(existingQuery);
                const deactivatePromises = [];
                
                existingSnapshot.forEach((doc) => {
                    console.log('Deactivating existing animation:', doc.id);
                    deactivatePromises.push(updateDoc(doc.ref, { status: 'inactive' }));
                });
                
                // Wait for all deactivations to complete
                await Promise.all(deactivatePromises);
                
                console.log(`Deactivated ${existingSnapshot.size} existing animations for event type: ${eventType}`);

                // Save new configuration to Firestore
                const docRef = await addDoc(collection(db, 'animation_configs'), config);
                
                // Also save animation data to a separate collection for easy access
                const animationStartTime = formData.get('animationStartTime');
                const formattedStartTime = animationStartTime.includes(':') && animationStartTime.split(':').length === 2 
                    ? animationStartTime + ':00'  // Add seconds if missing
                    : animationStartTime;
                
                await setDoc(doc(db, 'animations', selectedAnimation.animationId), {
                    ...selectedAnimation,
                    startTime: formattedStartTime + 'Z'  // Store with Z suffix for UTC
                });
                
                console.log('Configuration sauvegard√©e avec l\'ID: ', docRef.id);
                
                messageDiv.innerHTML = `
                    <div class="message success">
                        ‚úÖ Configuration et animation sauvegard√©es avec succ√®s !<br>
                        ${existingSnapshot.size > 0 ? `<small>Remplac√© ${existingSnapshot.size} animation(s) existante(s)</small><br>` : ''}
                        <small>Config ID: ${docRef.id}</small><br>
                        <small>Animation: ${selectedAnimation.animationId}</small>
                    </div>
                `;

                form.reset();
                preview.style.display = 'none';
                
            } catch (error) {
                console.error('Erreur lors de la sauvegarde: ', error);
                messageDiv.innerHTML = `
                    <div class="message error">
                        ‚ùå Erreur lors de la sauvegarde: ${error.message}
                    </div>
                `;
            } finally {
                submitBtn.disabled = false;
                loading.classList.remove('show');
            }
        });

        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        timeInput.min = now.toISOString().slice(0, 16);
    </script>
</body>
</html>